---
   - name: Secure the instances after they have been updated
     pre_tasks:
      - include_vars: "{{item}}"
        with_items:
          - vars/ec2.yml
          - vars/jupyter.yml
          - vars/deep_learning.yml
     tasks:
       - name: Find all instances named {{ ec2_tag_Name }} in {{ ec2_region }}
         # Gather facts about all running ec2 instances with a tag of Name:Example
         ec2_remote_facts:
           region: "{{ ec2_region }}"
           filters:
             instance-state-name: running
             "tag:Name": "{{ec2_tag_Name}}"
         register: ec2

       - name: Debug
         debug:
           msg: "{{ ec2 }}"

       - name: update security group
         local_action:
         module: >
            shell
              aws ec2 modify-instance-attribute --instance-id "{{ ec2_id }}"
              --groups "{{ec2_security_group_ids}}" "{{newgroup.group_id}}"
         when: newgroup.group_id not in ec2_security_group_ids
